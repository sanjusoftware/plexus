# ==============================================================================
# LOCAL DEVELOPMENT REQUIREMENT:
# Before running 'docker-compose up', you MUST add the following to your
# system's hosts file (C:\Windows\System32\drivers\etc\hosts):
#
# 127.0.0.1 identity-provider
# ==============================================================================

services:
  # 1. PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: bankengine-db
    environment:
      POSTGRES_DB: bankengine
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d bankengine"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Mock OAuth Server
  oauth-mock:
    image: ghcr.io/navikt/mock-oauth2-server:2.1.10
    container_name: oauth-mock
    ports:
      - "9090:9090"
    environment:
      - SERVER_PORT=9090

  # 3. Spring Boot Application
  app:
    build: .
    container_name: bankengine-app
    ports:
      - "8080:8080"
    extra_hosts:
      - "identity-provider:host-gateway"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
    depends_on:
      db:
        condition: service_healthy
      oauth-mock:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 25s